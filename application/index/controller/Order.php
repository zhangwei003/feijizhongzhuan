<?php/** *  +---------------------------------------------------------------------- *  | 狂神系统系统 [ WE CAN DO IT JUST THINK ] *  +---------------------------------------------------------------------- *  | Copyright (c) 2018 http://www.iredcap.cn All rights reserved. *  +---------------------------------------------------------------------- *  | Licensed ( https://www.apache.org/licenses/LICENSE-2.0 ) *  +---------------------------------------------------------------------- *  | Author: Brian Waring <BrianWaring98@gmail.com> *  +---------------------------------------------------------------------- */namespace app\index\controller;use app\common\library\enum\OrderStatusEnum;use app\common\model\Orders;class Order extends Base{	/**	 * 商户交易订单	 *	 * @author 勇敢的小笨羊 <brianwaring98@gmail.com>	 *	 * @return mixed	 */	public function index(){		$where = ['uid' => is_login()];		//组合搜索		!empty($this->request->get('trade_no')) && $where['out_trade_no']			= ['like', '%'.$this->request->get('trade_no').'%'];		!empty($this->request->get('channel')) && $where['channel']			= ['eq', $this->request->get('channel')];		//时间搜索  时间戳搜素		$date = $this->request->param('d/a');		$start = empty($date['start']) ? date('Y-m-d ')." 00:00:00" : $date['start'];		$end = empty($date['end']) ? date('Y-m-d')." 23:59:59" : $date['end'];		$where['create_time'] = ['between', [strtotime($start), strtotime($end)]];		//状态		if(!empty($this->request->get('status')) || $this->request->get('status') === '0')		{			$where['status'] = $this->request->get('status');		}		$orderLists = $this->logicOrders->getOrderList($where,true, 'create_time desc', 10);        //查询当前符合条件的订单的的总金额  编辑封闭 新增放开 原则        $cals =  $this->logicOrders->calOrdersData($where);        $this->assign('list',$orderLists );        $this->assign('cal',$cals);		$this->assign('code',$this->logicPay->getCodeList([]));		$this->assign('start', $start);		$this->assign('end', $end);		return $this->fetch();	}	/**	 * 商户退款订单	 *	 * @author 勇敢的小笨羊 <brianwaring98@gmail.com>	 *	 * @return mixed	 */	public function refund(){		$where = ['uid' => is_login()];		//组合搜索		!empty($this->request->get('trade_no')) && $where['trade_no']			= ['like', '%'.$this->request->get('trade_no').'%'];		!empty($this->request->get('channel')) && $where['channel']			= ['eq', $this->request->get('channel')];		//时间搜索  时间戳搜素		$where['create_time'] = $this->parseRequestDate();		//状态		$where['status'] = ['eq', $this->request->get('status',OrderStatusEnum::UNPAID)];		//halt($this->logicOrders->getOrderList($where,true, 'create_time desc', 10));		$this->assign('list', $this->logicOrders->getOrderList($where,true, 'create_time desc', 10));		return $this->fetch();	}	/**	 *	 * @author 勇敢的小笨羊 <brianwaring98@gmail.com>	 *	 * @return mixed	 */	public function submit(){		$where = ['uid' => is_login()];		$this->assign('list', $this->logicOrders->getOrderList($where,true, 'create_time desc', 10));		return $this->fetch();	}	/**	 * 导出订单	 */	public function  exportOrder(){		$where = ['uid' => is_login()];		//组合搜索		!empty($this->request->get('trade_no')) && $where['out_trade_no']			= ['like', '%'.$this->request->get('trade_no').'%'];		!empty($this->request->get('channel')) && $where['channel']			= ['eq', $this->request->get('channel')];		//时间搜索  时间戳搜素		$date = $this->request->param('d/a');		$start = empty($date['start']) ? date('Y-m-d',time()) : $date['start'];		$end = empty($date['end']) ? date('Y-m-d',time()+3600*24) : $date['end'];		$where['create_time'] = ['between', [strtotime($start), strtotime($end)]];		//状态		if(!empty($this->request->get('status')) || $this->request->get('status') === '0')		{			$where['status'] = $this->request->get('status');		}		//导出默认为选择项所有		$orderList = $this->logicOrders->getOrderList($where,true, 'create_time desc', false);		//组装header 响应html为execl 感觉比PHPExcel类更快		$orderStatus =['订单关闭','等待支付','支付完成','异常订单'];		$strTable ='<table width="500" border="1">';		$strTable .= '<tr>';		$strTable .= '<td style="text-align:center;font-size:12px;width:120px;">ID标识</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="100">订单号</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="*">金额</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="*">收入</td>';        $strTable .= '<td style="text-align:center;font-size:12px;" width="*">手续费</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="*">支付渠道</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="*">创建时间</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="*">更新时间</td>';		$strTable .= '<td style="text-align:center;font-size:12px;" width="*">状态</td>';		$strTable .= '</tr>';		if(is_array($orderList)){			foreach($orderList as $k=>$val){                $shouxufei = $val['platform_in'] + $val['agent_in'];				$strTable .= '<tr>';				$strTable .= '<td style="text-align:center;font-size:12px;">&nbsp;'.$val['id'].'</td>';				$strTable .= '<td style="text-align:left;font-size:12px;">&nbsp;'.$val['out_trade_no'].' </td>';				$strTable .= '<td style="text-align:left;font-size:12px;">'.$val['amount'].'</td>';				$strTable .= '<td style="text-align:left;font-size:12px;">'.$val['user_in'].'</td>';                $strTable .= '<td style="text-align:left;font-size:12px;">'.$shouxufei.'</td>';				$strTable .= '<td style="text-align:left;font-size:12px;">'.$val['channel'].'</td>';				$strTable .= '<td style="text-align:left;font-size:12px;">'.$val['create_time'].'</td>';				$strTable .= '<td style="text-align:left;font-size:12px;">'.$val['update_time'].'</td>';				$strTable .= '<td style="text-align:left;font-size:12px;">'.$orderStatus[$val['status']].'</td>';				$strTable .= '</tr>';				unset($orderList[$k]);			}		}		$strTable .='</table>';		downloadExcel($strTable,'order');	}}